* conda activate jfbio_36_4




---- LABEL ----
https://github.com/tzutalin/labelImg
sudo apt-get install qt5-default
sudo apt-get install pyqt5-dev-tools
sudo pip3 install -r requirements/requirements-linux-python3.txt  # delete qt5 from requirements
make qt5py3

$ python3 labelImg.py
set folders: images/train, images/test




---- XML -> CSV -> TFRECORD ----
images/test -> .xml
images/train -> .xml
create object-detection.pbtxt

$ python xml_to_csv.py --folder /home/miguel/Desktop/HALIMEDA_TEST/DATA/images/

$ python3 generate_tfrecord.py --folder /home/miguel/Desktop/HALIMEDA_TEST/DATA/images




---- TRAIN ----
move data and dictionary to models/reserch/object_detection/data/...
add architecture to architectures/..
add test images to test_images
modify training/hp.config



Things to change in order to exec a different model/config/dataset/...

folders:

  - models/research/object_detection
      - data/ .record, .csv, object-detection.pbtxt     # folder with the records and cvs generated and the labels of the objects
      - "model_folder"/			      		# add folder with the downloaded model
      - images/test,train (image + xml)	     		# add folder with the images and xml annotations
      - training/"model".config             		# model config
      - export_inference_graph.py -> "folder/output"/     # folder to save the frozen inference graph after the training is done
      - test_images/ 			      		# add images to test on the jupyter notebook

scripts:

  - aux/folder/generate_tfrecord.py -> class_text_to_int -> row_label = "xxx" return 1, else if row_label == "yyy" return 2 # set accordingly to the dictionary

  - models/research/object_detection/training/"model".config:    # change the model configuration
      - num_classes: "xx"
      - batch_size: "xx"
      - fine_tune_checkpoint: "model"/model.ckpt

      - train_input_reader
          input_path: "PATH_TO_BE_CONFIGURED/mscoco_train.record-?????-of-00100"
          label_map_path: "PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt"

      - eval_input_reader
          input_path: "PATH_TO_BE_CONFIGURED/mscoco_val.record-?????-of-00010"
          label_map_path: "PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt"


  - models/research/object_detection/data/object-detection.pbtxt -> deffine dictionary


$ python3 train.py --logtostderr --train_dir=RUNS/halimeda_test/ --pipeline_config_path=training/halimeda_test/halimeda.config




---- INFERENCE ----
$ python3 export_inference_graph.py --input_type image_tensor --pipeline_config_path=training/halimeda_test/halimeda.config --trained_checkpoint_prefix RUNS/halimeda_test/model.ckpt-200 --output_directory RUNS/halimeda_test/frozen

$ python3 inference.py --inference_graph_dir=RUNS/halimeda_test/frozen/ --print_thr 0.1 --test_dir test_images/halimeda_test/ --out_dir results/halimeda_test/ --id "" --n_classes 1 --labels_file data/halimeda_test/object_detection.pbtxt




---- POST1 ----
$ python nms.py --path_in /home/miguel/models/research/object_detection/results/jf_bio/bal_art/1/txt/ --path_out /home/miguel/models/research/object_detection/results/jf_bio/bal_art/1/nms/ --thr 0.4




---- EVAL ----
$ python xml_to_txt_med_atl.py --path_in data/med_atl/c1/images/test/ --path_out /home/miguel/models/research/object_detection/results/jf_bio/med_atl/1/gt/

$ python pascalvoc.py -tiou 0.5 -tconf 0 -gtformat=xyrb -detformat=xyrb -gt /home/miguel/models/research/object_detection/results/halimeda_test/gt_txt/ -det /home/miguel/models/research/object_detection/results/halimeda_test/nms/ -sp /home/miguel/models/research/object_detection/results/halimeda_test/eval/ -sn results -np

$ python pascalvoc_matrix.py -tiou 0.5 -tconf 0.78 -gtformat=xyrb -detformat=xyrb -gt /home/miguel/models/research/object_detection/results/halimeda_test/gt_txt/ -det /home/miguel/models/research/object_detection/results/halimeda_test/nms/ -sp /home/miguel/models/research/object_detection/results/halimeda_test/eval/ -sn matrix -np




---- POST 2 ----
$ python cthr.py --path_in /home/miguel/models/research/object_detection/results/halimeda_test/nms/ --path_out /home/miguel/models/research/object_detection/results/halimeda_test/cthr/ --cthr 0.70

$ python /home/miguel/Desktop/object_detection_utils/metrics/lib/printbb.py --path_im test_images/jf_bio/halimeda_test/ --path_txt results/jf_bio/halimeda_test/cthr/ --path_out results/jf_bio/halimeda_test/output_cthr/



----------------------------------------------------------------
 - if ImportError: No module named 'object_detection'
from models/research: export PYTHONPATH=$PYTHONPATH:`pwd`:`pwd`/slim

 - if error: failed to alocate memory:
watch -n 1 free -n
sudo sync && sudo sysctl -w vm.drop_caches=3











